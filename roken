//
//  ContentView.swift
//  Roken
//
//  Updated with MULTIPLE photos + REMOVE button
//

import SwiftUI
import Combine
import PhotosUI

// MARK: - Model
struct Item: Identifiable, Codable {
    let id = UUID()
    var title: String
    var price: String
    var description: String
    var imageDataArray: [Data] = []   // â† Now an array!
}

// MARK: - ViewModel
class ItemViewModel: ObservableObject {
    @Published var items: [Item] = []
    
    private static let itemsKey = "SavedRokenItems"
    
    func addItem(title: String,
                 price: String,
                 description: String,
                 imageDataArray: [Data]) {
        let newItem = Item(title: title,
                           price: price,
                           description: description,
                           imageDataArray: imageDataArray)
        items.append(newItem)
        save()
    }
    
    // MARK: Persistence
    func save() {
        if let encoded = try? JSONEncoder().encode(items) {
            UserDefaults.standard.set(encoded, forKey: Self.itemsKey)
        }
    }
    
    func load() {
        guard let data = UserDefaults.standard.data(forKey: Self.itemsKey),
              let decoded = try? JSONDecoder().decode([Item].self, from: data) else { return }
        items = decoded
    }
}

// MARK: - App Entry
@main
struct RokenApp: App {
    @StateObject private var itemVM = ItemViewModel()
    
    init() {
        _itemVM.wrappedValue.load()
    }
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(itemVM)
                .onReceive(itemVM.$items) { _ in
                    itemVM.save()
                }
        }
    }
}

// MARK: - Main List
struct ContentView: View {
    @EnvironmentObject var itemVM: ItemViewModel
    
    var body: some View {
        NavigationStack {
            ZStack {
                Color.orange.ignoresSafeArea()
                
                VStack {
                    if itemVM.items.isEmpty {
                        Spacer()
                        Text("No Items posted yet")
                            .foregroundColor(.white)
                            .font(.title2)
                            .padding()
                            .background(Color.black.opacity(0.2))
                            .cornerRadius(12)
                        Spacer()
                    } else {
                        ScrollView {
                            VStack(spacing: 16) {
                                ForEach(itemVM.items) { item in
                                    NavigationLink(destination: ItemDetailView(item: item)) {
                                        HStack(spacing: 12) {
                                            // First image as thumbnail
                                            if let firstData = item.imageDataArray.first,
                                               let uiImage = UIImage(data: firstData) {
                                                Image(uiImage: uiImage)
                                                    .resizable()
                                                    .scaledToFill()
                                                    .frame(width: 60, height: 60)
                                                    .clipShape(RoundedRectangle(cornerRadius: 8))
                                            } else {
                                                Rectangle()
                                                    .fill(Color.gray.opacity(0.3))
                                                    .frame(width: 60, height: 60)
                                                    .overlay(
                                                        Image(systemName: "photo")
                                                            .foregroundColor(.white)
                                                    )
                                                    .clipShape(RoundedRectangle(cornerRadius: 8))
                                            }
                                            
                                            VStack(alignment: .leading, spacing: 4) {
                                                Text(item.title)
                                                    .font(.headline)
                                                    .foregroundColor(.black)
                                                Text("$\(item.price)")
                                                    .foregroundColor(.green)
                                            }
                                            Spacer()
                                            
                                            if item.imageDataArray.count > 1 {
                                                Text("+\(item.imageDataArray.count - 1)")
                                                    .font(.caption)
                                                    .padding(6)
                                                    .background(Color.blue.opacity(0.7))
                                                    .foregroundColor(.white)
                                                    .clipShape(Circle())
                                            }
                                        }
                                        .padding()
                                        .background(Color.white.opacity(0.9))
                                        .cornerRadius(16)
                                    }
                                }
                            }
                            .padding()
                        }
                    }
                }
            }
            .navigationTitle("Roken")
            .toolbar {
                NavigationLink(destination: AddItemView()) {
                    Image(systemName: "plus")
                        .imageScale(.large)
                        .foregroundStyle(.tint)
                }
            }
        }
    }
}

// MARK: - Detail View (Gallery)
struct ItemDetailView: View {
    var item: Item
    
    var body: some View {
        ZStack {
            Color.orange.ignoresSafeArea()
            ScrollView {
                VStack(alignment: .leading, spacing: 20) {
                    // Image Gallery
                    if !item.imageDataArray.isEmpty {
                        ScrollView(.horizontal, showsIndicators: false) {
                            HStack(spacing: 12) {
                                ForEach(item.imageDataArray, id: \.self) { data in
                                    if let uiImage = UIImage(data: data) {
                                        Image(uiImage: uiImage)
                                            .resizable()
                                            .scaledToFit()
                                            .frame(height: 220)
                                            .clipShape(RoundedRectangle(cornerRadius: 16))
                                            .overlay(
                                                RoundedRectangle(cornerRadius: 16)
                                                    .stroke(Color.white, lineWidth: 2)
                                            )
                                    }
                                }
                            }
                            .padding(.horizontal)
                        }
                        .padding(.bottom, 8)
                    }
                    
                    Text(item.title)
                        .font(.largeTitle)
                        .bold()
                    
                    Text("Price: $\(item.price)")
                        .font(.title2)
                        .foregroundColor(.green)
                    
                    Text("Description:")
                        .font(.headline)
                    
                    Text(item.description)
                        .padding(.bottom, 50)
                    
                    Spacer()
                }
                .padding()
            }
            .navigationTitle("Item details")
        }
    }
}

// MARK: - Add Item View (Multiple Photos + Remove)
struct AddItemView: View {
    @EnvironmentObject var itemVM: ItemViewModel
    @Environment(\.dismiss) var dismiss
    
    @State private var title: String = ""
    @State private var price: String = ""
    @State private var description: String = ""
    @State private var selectedPhotos: [PhotosPickerItem] = []
    @State private var previewImages: [UIImage] = []
    
    var body: some View {
        ZStack {
            Color.orange.ignoresSafeArea()
            VStack(spacing: 24) {
                // ----- Item Info -----
                VStack(alignment: .leading, spacing: 16) {
                    Text("Item Info")
                        .font(.title2)
                        .bold()
                        .foregroundColor(.white)
                    
                    TextField("Title", text: $title)
                        .textFieldStyle(.roundedBorder)
                    TextField("Price", text: $price)
                        .keyboardType(.decimalPad)
                        .textFieldStyle(.roundedBorder)
                    TextField("Description", text: $description)
                        .textFieldStyle(.roundedBorder)
                }
                .padding()
                .background(.orange.opacity(0.3))
                .cornerRadius(16)
                
                // ----- Photo Picker -----
                PhotosPicker(selection: $selectedPhotos,
                             maxSelectionCount: 10,
                             matching: .images,
                             photoLibrary: .shared()) {
                    Label("Add Photos (\(previewImages.count)/10)", systemImage: "photo")
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.blue.opacity(0.8))
                        .foregroundColor(.white)
                        .cornerRadius(10)
                }
                .onChange(of: selectedPhotos) { newPhotos in
                    Task {
                        var newImages: [UIImage] = []
                        for photo in newPhotos {
                            if let data = try? await photo.loadTransferable(type: Data.self),
                               let image = UIImage(data: data) {
                                newImages.append(image)
                            }
                        }
                        // Replace with new selection (PhotosPicker replaces entire array)
                        previewImages = newImages
                    }
                }
                
                // ----- Photo Grid Preview with Remove Button -----
                if !previewImages.isEmpty {
                    LazyVGrid(columns: [
                        GridItem(.flexible()),
                        GridItem(.flexible()),
                        GridItem(.flexible())
                    ], spacing: 12) {
                        ForEach(previewImages.indices, id: \.self) { index in
                            ZStack(alignment: .topTrailing) {
                                Image(uiImage: previewImages[index])
                                    .resizable()
                                    .scaledToFill()
                                    .frame(height: 120)
                                    .clipShape(RoundedRectangle(cornerRadius: 12))
                                    .overlay(
                                        RoundedRectangle(cornerRadius: 12)
                                            .stroke(Color.white, lineWidth: 2)
                                    )
                                
                                Button(action: {
                                    previewImages.remove(at: index)
                                }) {
                                    Image(systemName: "xmark.circle.fill")
                                        .foregroundColor(.red)
                                        .background(Color.white.clipShape(Circle()))
                                        .font(.title3)
                                }
                                .offset(x: 8, y: -8)
                            }
                        }
                    }
                    .padding(.horizontal)
                }
                
                // ----- Post Button -----
                Button(action: {
                    let imageDataArray = previewImages.compactMap { $0.jpegData(compressionQuality: 0.8) }
                    itemVM.addItem(title: title,
                                   price: price,
                                   description: description,
                                   imageDataArray: imageDataArray)
                    dismiss()
                }) {
                    Text("Post Item")
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(Color.blue)
                        .foregroundColor(.white)
                        .cornerRadius(10)
                }
                .disabled(title.isEmpty || price.isEmpty || description.isEmpty)
            }
            .padding()
            .navigationTitle("Add Item")
        }
    }
}

// MARK: - Preview
#Preview {
    ContentView()
        .environmentObject(ItemViewModel())
}

